/*
 * log_format.c
 *
 *  Created on: Jan 19, 2026
 *      Author: Sterm
 */

#include "log/log_format.h"
#include <stdio.h>

#include <string.h>
#include "shared_resources/global_faults.h"
#include "shared_resources/board1_faults.h"
static const char *CommUnpackStatusToStr(CommUnpackStatus_t s)
{
    switch (s)
    {
        case COMM_UNPACK_OK:   return "OK";
        case COMM_UNPACK_NULL: return "NULL";
        case COMM_UNPACK_LEN:  return "LEN";
        case COMM_UNPACK_CRC:  return "CRC";
        default:               return "UNK";
    }
}

static const char *FaultFlagsToStr(uint32_t flags)
{
    static char buf[64];

    if (flags == FAULT_NONE)
    {
        strcpy(buf, "NONE");
        return buf;
    }

    buf[0] = '\0';

    if (flags & FAULT_TEMP)      strcat(buf, "TEMP-");
    if (flags & FAULT_BATT)      strcat(buf, "BATT-");
    if (flags & FAULT_RX)       strcat(buf, "RX-");
    if (flags & FAULT_WHEEL_FL) strcat(buf, "FL-");
    if (flags & FAULT_WHEEL_FR)          strcat(buf, "FR-");
    if (flags & FAULT_WHEEL_RL)    strcat(buf, "RL-");
    if (flags & FAULT_WHEEL_RR)            strcat(buf, "RR-");
    if (flags & FAULT_B2_SUP)            strcat(buf, "B2SUP-");


    /* rimuove l'ultimo '|' */
    buf[strlen(buf) - 1] = '\0';

    return buf;
}


void Log_FormatSnapshot(char *buf,
                        unsigned buf_len,
                        const BleControllerSnapshot_t *ble,
                        const IMUSnapshot_t *imu,
                        const SonarSnapshot_t *sonar,
						const RxSnapshot_t *rx)
{
    if (!buf || !ble || !imu || !sonar || !rx)
        return;

    snprintf(buf, buf_len,
        "[SNAPSHOT]\r\n"
        "BLE   t=%lu | AX=%.2f AY=%.2f | BTN=%d%d%d%d (data time: %lu) \r\n"
        "IMU   t=%lu | ACC(%.2f %.2f %.2f) | GYR(%.2f %.2f %.2f) yaw: %.2f | T=%.1f (data time: %lu)\r\n"
        "SONAR t=%lu | F=%ucm (t: %lu) | L=%ucm (t: %lu) | R=%ucm (t: %lu) | \r\n"
        "RX t = %lu | last=%s | valid_t=%lu\r\n"
        "RX PAYLOAD | FL=%.2f FR=%.2f RL=%.2f RR=%.2f | critical=%s | degraded=%s | alive=%u\r\n\r\n",

        /* BLE */
        ble->task_last_run_ms,
        ble->bx_norm, ble->ay_norm,
        ble->a_btn, ble->b_btn, ble->btn1, ble->btn2,
        ble->data_last_valid_ms,
		//ble->i2c_status,

        /* IMU */
        imu->task_last_run_ms,
        imu->ax_g, imu->ay_g, imu->az_g,
        imu->gx_dps, imu->gy_dps, imu->gz_dps, imu->yaw,
        imu->temperature_degC,
        imu->data_last_valid_ms,

        /* SONAR */
        sonar->task_last_run_ms,
        sonar->dist_cm[0], sonar->data_last_valid_ms[0],
        sonar->dist_cm[1], sonar->data_last_valid_ms[1],
        sonar->dist_cm[2], sonar->data_last_valid_ms[2],
        //(sonar->valid_mask != 0U) ? "OK" : "INV",

        /* RX SNAPSHOT B1 */
        rx->task_last_run_ms,
        CommUnpackStatusToStr(rx->last_event),
        rx->data_last_valid_ms,

        rx->payload.wheel_speed_rpm[0],
        rx->payload.wheel_speed_rpm[1],
        rx->payload.wheel_speed_rpm[2],
        rx->payload.wheel_speed_rpm[3],
		FaultFlagsToStr(rx->payload.critical_mask),
        FaultFlagsToStr(rx->payload.degraded_mask),
        rx->payload.alive_counter
    );

}

