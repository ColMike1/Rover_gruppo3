/*
 * comm_pack.c
 *
 *  Created on: Jan 11, 2026
 *      Author: Sterm
 */
#include <string.h>
#include "comm/comm_pack.h"
#include "shared_resources/comm_crc.h"
#include "shared_resources/comm_message_structures.h"

/* ================= PACK FUNCTION ================= */

uint16_t CommPack_BuildB2Tx(uint8_t *buf,
                                    uint16_t max_len,
                                    const BleControllerSnapshot_t *ble,
                                    const SupervisorSnapshot_t *sup,
									const IMUSnapshot_t *imu)
{
    if (!buf || !sup || !ble)
        return 0;

    /* frame sizes */
    const uint16_t HEADER_LEN = sizeof(CommFrameHeader_t);
    const uint16_t PAYLOAD_LEN = sizeof(CommPayloadB2_t);
    const uint16_t CRC_LEN = sizeof(uint16_t);
    const uint16_t FRAME_LEN = sizeof(CommFrameB2_t);

    if (max_len < FRAME_LEN)
        return 0;

    static uint16_t tx_seq = 0;

    uint16_t i = 0;

    /* ---------- Header ---------- */
    CommFrameHeader_t hdr;

    hdr.payload_len  = PAYLOAD_LEN;
    hdr.seq          = ++tx_seq;
    hdr.timestamp_ms = sup->task_last_run_ms;
    hdr.msg_id = 0xAA56;

    memcpy(&buf[i], &hdr, HEADER_LEN);
    i += HEADER_LEN;


    /* ---------- Payload ---------- */
    CommPayloadB2_t pl;

    pl.command        = sup->command;
    pl.degraded_mask  = sup->degraded_mask;
    pl.critical_mask  = sup->critical_mask;
    pl.imu_coherence_status  = sup->imu_coherence;
    pl.yaw				= imu->yaw;
    pl.x_norm         = ble->bx_norm;
    pl.y_norm         = ble->ay_norm;

    //DA CAMBIARE
    pl.alive_counter  = sup->alive_counter;


    memcpy(&buf[i], &pl, PAYLOAD_LEN);
    i += PAYLOAD_LEN;

    /* ---------- CRC ---------- */
    uint16_t crc = crc16_ccitt(buf, i);
    memcpy(&buf[i], &crc, CRC_LEN);
    i += CRC_LEN;

    return i;  /* == FRAME_LEN */
}

