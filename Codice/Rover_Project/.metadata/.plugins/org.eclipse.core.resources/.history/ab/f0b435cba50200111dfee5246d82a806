/*
 * wcet_monitor.c
 *
 *  Created on: Jan 21, 2026
 *      Author: Sterm
 */

#include "stm32g4xx.h"
#include "log/wcet_monitor.h"
#include <stdint.h>
#include <stdio.h>
#include <math.h>


#define WCET_MAX(a,b)  (((a) > (b)) ? (a) : (b))

static uint32_t wcet_max[WCET_ID_MAX];

void WCET_Update(wcet_id_t id, uint32_t cycles)
{
    if (cycles > wcet_max[id])
        wcet_max[id] = cycles;
}

void WCET_Print(void)
{
    const double cyc2us = 1e6 / (double)SystemCoreClock;

    /* ================= TASK ================= */
    printf(
        "WCET TASK |"
        "BLE=%lu (%.2fus) "
        "IMU=%lu (%.2fus) "
        "SONAR=%lu (%.2fus)\r\n"
		"SUPERVISOR=%lu (%.2fus)\r\n",
        wcet_max[WCET_TASK_BLE],
        wcet_max[WCET_TASK_BLE] * cyc2us,
        wcet_max[WCET_TASK_IMU],
        wcet_max[WCET_TASK_IMU] * cyc2us,
        wcet_max[WCET_TASK_SONAR],
        wcet_max[WCET_TASK_SONAR] * cyc2us,
        wcet_max[WCET_TASK_SUPERVISOR],
        wcet_max[WCET_TASK_SUPERVISOR] * cyc2us,
    );

    /* ================= I2C ISR ================= */
    printf(
        "WCET ISR I2C |"
        "I2C1_EV=%lu (%.2fus) "
        "I2C1_ER=%lu (%.2fus) "
        "I2C3_EV=%lu (%.2fus) "
        "I2C3_ER=%lu (%.2fus)\r\n",
        wcet_max[WCET_ISR_I2C1_EV],
        wcet_max[WCET_ISR_I2C1_EV] * cyc2us,
        wcet_max[WCET_ISR_I2C1_ER],
        wcet_max[WCET_ISR_I2C1_ER] * cyc2us,
        wcet_max[WCET_ISR_I2C3_EV],
        wcet_max[WCET_ISR_I2C3_EV] * cyc2us,
        wcet_max[WCET_ISR_I2C3_ER],
        wcet_max[WCET_ISR_I2C3_ER] * cyc2us
    );

    /* ================= DMA ISR ================= */
    printf(
        "WCET ISR DMA |"
        "DMA1=%lu (%.2fus) "
        "DMA2=%lu (%.2fus) "
        "DMA3=%lu (%.2fus) "
        "DMA4=%lu (%.2fus)\r\n",
        wcet_max[WCET_ISR_DMA_1],
        wcet_max[WCET_ISR_DMA_1] * cyc2us,
        wcet_max[WCET_ISR_DMA_2],
        wcet_max[WCET_ISR_DMA_2] * cyc2us,
        wcet_max[WCET_ISR_DMA_3],
        wcet_max[WCET_ISR_DMA_3] * cyc2us,
        wcet_max[WCET_ISR_DMA_4],
        wcet_max[WCET_ISR_DMA_4] * cyc2us
    );

    /* ================= TIM ISR ================= */
    printf(
        "WCET ISR TIM |"
        "TIM_IC=%lu (%.2fus)\r\n",
        wcet_max[WCET_ISR_TIM_IC],
        wcet_max[WCET_ISR_TIM_IC] * cyc2us
    );

    /* ================= FEATURE CPU COST (informativo) ================= */
    printf(
        "WCET FEATURE CPU |"
    	"BLE=%lu (%.2fus) "
		"IMU=%lu (%.2fus) "
		"SONAR=%lu (%.2fus) "
    	"RX =%lu (%.2fus) "
    	"TX =%lu (%.2fus)\r\n\n\n",

        wcet_max[WCET_TASK_BLE] + WCET_MAX(wcet_max[WCET_ISR_I2C1_EV],wcet_max[WCET_ISR_I2C1_ER]),
        (wcet_max[WCET_TASK_BLE] + WCET_MAX(wcet_max[WCET_ISR_I2C1_EV],wcet_max[WCET_ISR_I2C1_ER])) * cyc2us,
        wcet_max[WCET_TASK_IMU] + WCET_MAX(wcet_max[WCET_ISR_I2C3_EV], wcet_max[WCET_ISR_I2C3_ER]),
        (wcet_max[WCET_TASK_IMU] +  WCET_MAX(wcet_max[WCET_ISR_I2C3_EV], wcet_max[WCET_ISR_I2C3_ER])) * cyc2us,
        wcet_max[WCET_TASK_SONAR] + wcet_max[WCET_ISR_DMA_1] + wcet_max[WCET_ISR_DMA_2] + wcet_max[WCET_ISR_DMA_3],
        (wcet_max[WCET_TASK_SONAR] + wcet_max[WCET_ISR_DMA_1] + wcet_max[WCET_ISR_DMA_2] + wcet_max[WCET_ISR_DMA_3]) * cyc2us,

        wcet_max[WCET_TASK_RX],
        wcet_max[WCET_TASK_RX] * cyc2us,

        wcet_max[WCET_TASK_TX] + wcet_max[WCET_ISR_DMA_4],
        (wcet_max[WCET_TASK_TX] + wcet_max[WCET_ISR_DMA_4]) * cyc2us
    );
}

