/*
 * Academic License - for use in teaching, academic research, and meeting
 * course requirements at degree granting institutions only.  Not for
 * government, commercial, or other organizational use.
 *
 * File: SupervisorB1.c
 *
 * Code generated for Simulink model 'SupervisorB1'.
 *
 * Model version                  : 1.129
 * Simulink Coder version         : 24.2 (R2024b) 21-Jun-2024
 * C/C++ source code generated on : Wed Feb  4 18:52:33 2026
 *
 * Target selection: ert.tlc
 * Embedded hardware selection: Intel->x86-64 (Windows64)
 * Code generation objectives: Unspecified
 * Validation result: Not run
 */

#include "SupervisorB1.h"
#include "snapshot/board_health_snapshot.h"
#include "SupervisorB1_types.h"
#include "rtwtypes.h"
#include <math.h>
#include "rt_nonfinite.h"
#include "shared_resources\imu_coherence_status.h"
#include "shared_resources/supervisor_command.h"
#include <string.h>
#include "SupervisorB1_private.h"

/* Named constants for Chart: '<Root>/Check rover safety state' */
#define Supervi_IN_Rover_Critical_State ((uint8_T)1U)
#define Supervi_IN_Rover_Degraded_State ((uint8_T)2U)
#define SupervisorB_IN_Rover_Safe_State ((uint8_T)3U)

/* Named constants for Chart: '<Root>/Monitor Board Status' */
#define IN_FrontRight_encoder_critical ((uint8_T)1U)
#define S_IN_FrontLeft_encoder_critical ((uint8_T)1U)
#define S_IN_RearRight_encoder_critical ((uint8_T)1U)
#define Su_IN_FrontRight_motor_critical ((uint8_T)2U)
#define Su_IN_RearLeft_encoder_critical ((uint8_T)1U)
#define Sup_IN_FrontLeft_motor_critical ((uint8_T)2U)
#define Sup_IN_RearRight_motor_critical ((uint8_T)2U)
#define Supe_IN_RearLeft_motor_critical ((uint8_T)2U)
#define Supervi_IN_Temperature_critical ((uint8_T)1U)
#define Supervi_IN_Temperature_degraded ((uint8_T)2U)
#define Supervis_IN_Temperature_timeout ((uint8_T)4U)
#define SupervisorB1_IN_B2_sup_critical ((uint8_T)1U)
#define SupervisorB1_IN_B2_sup_degraded ((uint8_T)2U)
#define SupervisorB1_IN_B2_sup_ok      ((uint8_T)3U)
#define SupervisorB1_IN_Battery_ok     ((uint8_T)3U)
#define SupervisorB1_IN_Battery_timeout ((uint8_T)4U)
#define SupervisorB1_IN_FrontLeft_ok   ((uint8_T)3U)
#define SupervisorB1_IN_FrontRight_ok  ((uint8_T)3U)
#define SupervisorB1_IN_RearLeft_ok    ((uint8_T)3U)
#define SupervisorB1_IN_RearRight_ok   ((uint8_T)3U)
#define SupervisorB1_IN_Temperature_ok ((uint8_T)3U)
#define SupervisorB_IN_Battery_critical ((uint8_T)1U)
#define SupervisorB_IN_Battery_degraded ((uint8_T)2U)

/* Block signals (default storage) */
B_SupervisorB1_T SupervisorB1_B;

/* Block states (default storage) */
DW_SupervisorB1_T SupervisorB1_DW;

/* External inputs (root inport signals with default storage) */
ExtU_SupervisorB1_T SupervisorB1_U;

/* External outputs (root outports fed by signals with default storage) */
ExtY_SupervisorB1_T SupervisorB1_Y;

/* Real-time model */
static RT_MODEL_SupervisorB1_T SupervisorB1_M_;
RT_MODEL_SupervisorB1_T *const SupervisorB1_M = &SupervisorB1_M_;

/* Forward declaration for local functions */
static boolean_T SupervisorB1_checkTempTimeout(uint32_T now_ms, uint32_T
  temp_last_valid_ms, real32_T temperature_degC);
static void SupervisorB1_MonitorTemperature(const BoardHealthSnapshot_t
  *BusConversion_InsertedFor_Mon_e, TemperatureStatus *temp_status);
static boolean_T SupervisorB_checkBatteryTimeout(uint32_T now_ms, uint32_T
  batt_last_valid_ms, real32_T batt_pct_last);
static void SupervisorB1_MonitorBattery(const BoardHealthSnapshot_t
  *BusConversion_InsertedFor_Mon_e, BatteryStatus *battery_status);
static boolean_T Supe_isCommDegradedByMeanPeriod(uint32_T data_last_valid_ms,
  real_T mean_threshold_ms);
static real32_T SupervisorB1_mod(real32_T x);
real_T rt_roundd_snf(real_T u)
{
  real_T y;
  if (fabs(u) < 4.503599627370496E+15) {
    if (u >= 0.5) {
      y = floor(u + 0.5);
    } else if (u > -0.5) {
      y = u * 0.0;
    } else {
      y = ceil(u - 0.5);
    }
  } else {
    y = u;
  }

  return y;
}

/* Function for Chart: '<Root>/Monitor Board Status' */
static boolean_T SupervisorB1_checkTempTimeout(uint32_T now_ms, uint32_T
  temp_last_valid_ms, real32_T temperature_degC)
{
  uint32_T dt_s;
  dt_s = now_ms -
    /*MW:operator MISRA2012:D4.1 CERT-C:INT30-C 'Justifying MISRA C rule violation'*/
    /*MW:OvSatOk*/ temp_last_valid_ms;
  if (dt_s > now_ms) {
    dt_s = 0U;
  }

  dt_s = (uint32_T)rt_roundd_snf((real_T)dt_s / 1000.0);
  return (!(dt_s < 0.5)) && (temperature_degC + (real32_T)dt_s >= 65.0F);
}

/* Function for Chart: '<Root>/Monitor Board Status' */
static void SupervisorB1_MonitorTemperature(const BoardHealthSnapshot_t
  *BusConversion_InsertedFor_Mon_e, TemperatureStatus *temp_status)
{
  switch (SupervisorB1_DW.is_MonitorTemperature) {
   case Supervi_IN_Temperature_critical:
    *temp_status = TEMP_HEALTH_CRITICAL;
    if ((!(BusConversion_InsertedFor_Mon_e->temperature_degC < 50.0F)) &&
        (!(BusConversion_InsertedFor_Mon_e->temperature_degC > 0.0F))) {
      SupervisorB1_DW.durationCounter_1_k = 0U;
    }

    if (SupervisorB1_DW.durationCounter_1_k > 250U) {
      SupervisorB1_DW.durationCounter_1_p = 0U;
      SupervisorB1_DW.is_MonitorTemperature = SupervisorB1_IN_Temperature_ok;
      *temp_status = TEMP_HEALTH_OK;
    }
    break;

   case Supervi_IN_Temperature_degraded:
    *temp_status = TEMP_HEALTH_DEGRADED;
    if ((!(BusConversion_InsertedFor_Mon_e->temperature_degC < 50.0F)) &&
        (!(BusConversion_InsertedFor_Mon_e->temperature_degC > 0.0F))) {
      SupervisorB1_DW.durationCounter_1_c = 0U;
    }

    if (SupervisorB1_DW.durationCounter_1_c > 500U) {
      SupervisorB1_DW.durationCounter_1_p = 0U;
      SupervisorB1_DW.is_MonitorTemperature = SupervisorB1_IN_Temperature_ok;
      *temp_status = TEMP_HEALTH_OK;
    } else {
      if ((!(BusConversion_InsertedFor_Mon_e->temperature_degC > 65.0F)) &&
          (!(BusConversion_InsertedFor_Mon_e->temperature_degC < -15.0F))) {
        SupervisorB1_DW.durationCounter_2 = 0U;
      }

      if (SupervisorB1_DW.durationCounter_2 > 200U) {
        SupervisorB1_DW.durationCounter_1_k = 0U;
        SupervisorB1_DW.is_MonitorTemperature = Supervi_IN_Temperature_critical;
        *temp_status = TEMP_HEALTH_CRITICAL;
      } else if (SupervisorB1_checkTempTimeout(SupervisorB1_U.now_ms,
                  BusConversion_InsertedFor_Mon_e->temp_last_valid_ms,
                  BusConversion_InsertedFor_Mon_e->temperature_degC)) {
        SupervisorB1_DW.durationCounter_1 = 0U;
        SupervisorB1_DW.is_MonitorTemperature = Supervis_IN_Temperature_timeout;
        *temp_status = TEMP_HEALTH_CRITICAL;
      }
    }
    break;

   case SupervisorB1_IN_Temperature_ok:
    *temp_status = TEMP_HEALTH_OK;
    if ((!(BusConversion_InsertedFor_Mon_e->temperature_degC > 55.0F)) &&
        (!(BusConversion_InsertedFor_Mon_e->temperature_degC < -5.0F))) {
      SupervisorB1_DW.durationCounter_1_p = 0U;
    }

    if (SupervisorB1_DW.durationCounter_1_p > 500U) {
      SupervisorB1_DW.durationCounter_2 = 0U;
      SupervisorB1_DW.durationCounter_1_c = 0U;
      SupervisorB1_DW.is_MonitorTemperature = Supervi_IN_Temperature_degraded;
      *temp_status = TEMP_HEALTH_DEGRADED;
    } else if (SupervisorB1_checkTempTimeout(SupervisorB1_U.now_ms,
                BusConversion_InsertedFor_Mon_e->temp_last_valid_ms,
                BusConversion_InsertedFor_Mon_e->temperature_degC)) {
      SupervisorB1_DW.durationCounter_1 = 0U;
      SupervisorB1_DW.is_MonitorTemperature = Supervis_IN_Temperature_timeout;
      *temp_status = TEMP_HEALTH_CRITICAL;
    }
    break;

   default:
    /* case IN_Temperature_timeout: */
    *temp_status = TEMP_HEALTH_CRITICAL;
    if ((!(BusConversion_InsertedFor_Mon_e->temperature_degC < 50.0F)) &&
        (!(BusConversion_InsertedFor_Mon_e->temperature_degC > 0.0F))) {
      SupervisorB1_DW.durationCounter_1 = 0U;
    }

    if (SupervisorB1_DW.durationCounter_1 > 250U) {
      SupervisorB1_DW.durationCounter_1_p = 0U;
      SupervisorB1_DW.is_MonitorTemperature = SupervisorB1_IN_Temperature_ok;
      *temp_status = TEMP_HEALTH_OK;
    }
    break;
  }
}

/* Function for Chart: '<Root>/Monitor Board Status' */
static boolean_T SupervisorB_checkBatteryTimeout(uint32_T now_ms, uint32_T
  batt_last_valid_ms, real32_T batt_pct_last)
{
  uint32_T dt_s;
  boolean_T timeout_fault;
  dt_s = now_ms -
    /*MW:operator MISRA2012:D4.1 CERT-C:INT30-C 'Justifying MISRA C rule violation'*/
    /*MW:OvSatOk*/ batt_last_valid_ms;
  if (dt_s > now_ms) {
    dt_s = 0U;
  }

  dt_s = (uint32_T)rt_roundd_snf((real_T)dt_s / 1000.0);
  if (dt_s < 0.5) {
    timeout_fault = false;
  } else {
    timeout_fault = (batt_pct_last - (real32_T)((uint32_T)rt_roundd_snf
      (rt_roundd_snf((real_T)dt_s / 3600.0) * 50.0 / 3.3) * 100U) <= 23.0F);
  }

  return timeout_fault;
}

/* Function for Chart: '<Root>/Monitor Board Status' */
static void SupervisorB1_MonitorBattery(const BoardHealthSnapshot_t
  *BusConversion_InsertedFor_Mon_e, BatteryStatus *battery_status)
{
  switch (SupervisorB1_DW.is_MonitorBattery) {
   case SupervisorB_IN_Battery_critical:
    *battery_status = BATTERY_HEALTH_CRITICAL;
    if (!(BusConversion_InsertedFor_Mon_e->battery_pct > 25.0F)) {
      SupervisorB1_DW.durationCounter_1_m = 0U;
    }

    if (SupervisorB1_DW.durationCounter_1_m > 250U) {
      SupervisorB1_DW.durationCounter_1_e = 0U;
      SupervisorB1_DW.is_MonitorBattery = SupervisorB1_IN_Battery_ok;
      *battery_status = BATTERY_HEALTH_OK;
    }
    break;

   case SupervisorB_IN_Battery_degraded:
    *battery_status = BATTERY_HEALTH_DEGRADED;
    if (!(BusConversion_InsertedFor_Mon_e->battery_pct > 25.0F)) {
      SupervisorB1_DW.durationCounter_1_d = 0U;
    }

    if (SupervisorB1_DW.durationCounter_1_d > 250U) {
      SupervisorB1_DW.durationCounter_1_e = 0U;
      SupervisorB1_DW.is_MonitorBattery = SupervisorB1_IN_Battery_ok;
      *battery_status = BATTERY_HEALTH_OK;
    } else {
      if (!(BusConversion_InsertedFor_Mon_e->battery_pct < 15.0F)) {
        SupervisorB1_DW.durationCounter_2_e = 0U;
      }

      if (SupervisorB1_DW.durationCounter_2_e > 250U) {
        SupervisorB1_DW.durationCounter_1_m = 0U;
        SupervisorB1_DW.is_MonitorBattery = SupervisorB_IN_Battery_critical;
        *battery_status = BATTERY_HEALTH_CRITICAL;
      } else if (SupervisorB_checkBatteryTimeout(SupervisorB1_U.now_ms,
                  BusConversion_InsertedFor_Mon_e->batt_last_valid_ms,
                  BusConversion_InsertedFor_Mon_e->battery_pct)) {
        SupervisorB1_DW.durationCounter_1_kv = 0U;
        SupervisorB1_DW.is_MonitorBattery = SupervisorB1_IN_Battery_timeout;
        *battery_status = BATTERY_HEALTH_CRITICAL;
      }
    }
    break;

   case SupervisorB1_IN_Battery_ok:
    *battery_status = BATTERY_HEALTH_OK;
    if (!(BusConversion_InsertedFor_Mon_e->battery_pct < 23.0F)) {
      SupervisorB1_DW.durationCounter_1_e = 0U;
    }

    if (SupervisorB1_DW.durationCounter_1_e > 250U) {
      SupervisorB1_DW.durationCounter_2_e = 0U;
      SupervisorB1_DW.durationCounter_1_d = 0U;
      SupervisorB1_DW.is_MonitorBattery = SupervisorB_IN_Battery_degraded;
      *battery_status = BATTERY_HEALTH_DEGRADED;
    } else if (SupervisorB_checkBatteryTimeout(SupervisorB1_U.now_ms,
                BusConversion_InsertedFor_Mon_e->batt_last_valid_ms,
                BusConversion_InsertedFor_Mon_e->battery_pct)) {
      SupervisorB1_DW.durationCounter_1_kv = 0U;
      SupervisorB1_DW.is_MonitorBattery = SupervisorB1_IN_Battery_timeout;
      *battery_status = BATTERY_HEALTH_CRITICAL;
    }
    break;

   default:
    /* case IN_Battery_timeout: */
    *battery_status = BATTERY_HEALTH_CRITICAL;
    if (!(BusConversion_InsertedFor_Mon_e->battery_pct > 25.0F)) {
      SupervisorB1_DW.durationCounter_1_kv = 0U;
    }

    if (SupervisorB1_DW.durationCounter_1_kv > 250U) {
      SupervisorB1_DW.durationCounter_1_e = 0U;
      SupervisorB1_DW.is_MonitorBattery = SupervisorB1_IN_Battery_ok;
      *battery_status = BATTERY_HEALTH_OK;
    }
    break;
  }
}

/* Function for Chart: '<Root>/Monitor Board Status' */
static boolean_T Supe_isCommDegradedByMeanPeriod(uint32_T data_last_valid_ms,
  real_T mean_threshold_ms)
{
  real_T old;
  uint32_T mean_dt;
  uint32_T q0;
  boolean_T comm_degraded;
  if (!SupervisorB1_DW.last_valid_prev_not_empty) {
    SupervisorB1_DW.last_valid_prev = data_last_valid_ms;
    SupervisorB1_DW.last_valid_prev_not_empty = true;
    memset(&SupervisorB1_DW.buf[0], 0, 10U * sizeof(real_T));
    SupervisorB1_DW.idx = 1.0;
    SupervisorB1_DW.count = 0.0;
    SupervisorB1_DW.sum_dt = 0U;
    comm_degraded = false;
  } else {
    if (data_last_valid_ms != SupervisorB1_DW.last_valid_prev) {
      mean_dt = data_last_valid_ms -
        /*MW:operator MISRA2012:D4.1 CERT-C:INT30-C 'Justifying MISRA C rule violation'*/
        /*MW:OvSatOk*/ SupervisorB1_DW.last_valid_prev;
      if (mean_dt > data_last_valid_ms) {
        mean_dt = 0U;
      }

      SupervisorB1_DW.last_valid_prev = data_last_valid_ms;
      old = SupervisorB1_DW.buf[(int32_T)SupervisorB1_DW.idx - 1];
      SupervisorB1_DW.buf[(int32_T)SupervisorB1_DW.idx - 1] = mean_dt;
      old = rt_roundd_snf((real_T)SupervisorB1_DW.sum_dt - old);
      if (old < 4.294967296E+9) {
        if (old >= 0.0) {
          q0 = (uint32_T)old;
        } else {
          q0 = 0U;
        }
      } else {
        q0 = MAX_uint32_T;
      }

      SupervisorB1_DW.sum_dt = q0 + /*MW:OvSatOk*/ mean_dt;
      if (SupervisorB1_DW.sum_dt < q0) {
        SupervisorB1_DW.sum_dt = MAX_uint32_T;
      }

      SupervisorB1_DW.idx++;
      if (SupervisorB1_DW.idx > 10.0) {
        SupervisorB1_DW.idx = 1.0;
      }

      if (SupervisorB1_DW.count < 10.0) {
        SupervisorB1_DW.count++;
      }
    }

    if (SupervisorB1_DW.count > 0.0) {
      old = rt_roundd_snf((real_T)SupervisorB1_DW.sum_dt / SupervisorB1_DW.count);
      if (old < 4.294967296E+9) {
        mean_dt = (uint32_T)old;
      } else {
        mean_dt = MAX_uint32_T;
      }
    } else {
      mean_dt = 0U;
    }

    comm_degraded = (mean_dt > mean_threshold_ms);
  }

  return comm_degraded;
}

/* Function for MATLAB Function: '<Root>/Set actuation command' */
static real32_T SupervisorB1_mod(real32_T x)
{
  real32_T r;
  if (rtIsNaNF(x)) {
    r = (rtNaNF);
  } else if (rtIsInfF(x)) {
    r = (rtNaNF);
  } else if (x == 0.0F) {
    r = 0.0F;
  } else {
    r = fmodf(x, 360.0F);
    if (r == 0.0F) {
      r = 0.0F;
    } else if (r < 0.0F) {
      r += 360.0F;
    }
  }

  return r;
}

/* Model step function */
void SupervisorB1_step(void)
{
  real_T OMEGA_GO_LEFT;
  real_T OMEGA_GO_RIGHT;
  real_T V_MAX;
  real_T V_MAX_MANEUVER;
  int32_T crit_mask;
  int32_T degr_mask;
  real32_T OMEGA_MAX;
  real32_T omega_user;
  real32_T v_user;
  uint32_T qY;
  boolean_T guard1;
  boolean_T motorFaultDetected_idx_0;
  boolean_T motorFaultDetected_idx_1;
  boolean_T motorFaultDetected_idx_2;
  boolean_T motorFaultDetected_idx_3;
  BatteryStatus battery_status;
  SafetyStatus rtb_rover_safety_state;
  SupervisorStatus b2_sup_status;
  TemperatureStatus temp_status;

  /* MATLAB Function: '<Root>/MATLAB Function1' incorporates:
   *  Inport: '<Root>/Board2_Data'
   *  UnitDelay: '<Root>/Unit Delay'
   */
  motorFaultDetected_idx_0 = false;
  motorFaultDetected_idx_1 = false;
  motorFaultDetected_idx_2 = false;
  motorFaultDetected_idx_3 = false;
  switch (SupervisorB1_U.Board2_Data.payload.imu_coherence_status) {
   case IMU_INCOHERENT_LEFT:
    motorFaultDetected_idx_0 = (SupervisorB1_DW.UnitDelay_DSTATE[0] ==
      WHEEL_DEGRADED_ENCODER);
    motorFaultDetected_idx_2 = (SupervisorB1_DW.UnitDelay_DSTATE[2] ==
      WHEEL_DEGRADED_ENCODER);
    break;

   case IMU_INCOHERENT_RIGHT:
    motorFaultDetected_idx_1 = (SupervisorB1_DW.UnitDelay_DSTATE[1] ==
      WHEEL_DEGRADED_ENCODER);
    motorFaultDetected_idx_3 = (SupervisorB1_DW.UnitDelay_DSTATE[3] ==
      WHEEL_DEGRADED_ENCODER);
    break;
  }

  /* End of MATLAB Function: '<Root>/MATLAB Function1' */

  /* Chart: '<Root>/Monitor Board Status' incorporates:
   *  Inport: '<Root>/Board_Health'
   *  Inport: '<Root>/Encoder'
   *  Inport: '<Root>/last_valid_b2_ms'
   *  Inport: '<Root>/now_ms'
   */
  if (SupervisorB1_DW.is_active_c2_SupervisorB1 == 0) {
    SupervisorB1_DW.is_active_c2_SupervisorB1 = 1U;
    SupervisorB1_DW.durationCounter_1_p = 0U;
    SupervisorB1_DW.is_MonitorTemperature = SupervisorB1_IN_Temperature_ok;
    temp_status = TEMP_HEALTH_OK;
    SupervisorB1_DW.durationCounter_1_e = 0U;
    SupervisorB1_DW.is_MonitorBattery = SupervisorB1_IN_Battery_ok;
    battery_status = BATTERY_HEALTH_OK;
    SupervisorB1_DW.is_MonitorFrontLeft = SupervisorB1_IN_FrontLeft_ok;
    SupervisorB1_B.wheel_status[0] = WHEEL_OK;
    SupervisorB1_DW.is_MonitorFrontRight = SupervisorB1_IN_FrontRight_ok;
    SupervisorB1_B.wheel_status[1] = WHEEL_OK;
    SupervisorB1_DW.is_MonitorRearLeft = SupervisorB1_IN_RearLeft_ok;
    SupervisorB1_B.wheel_status[2] = WHEEL_OK;
    SupervisorB1_DW.is_MonitorRearRight = SupervisorB1_IN_RearRight_ok;
    SupervisorB1_B.wheel_status[3] = WHEEL_OK;
    SupervisorB1_DW.is_MonitorBoard2Supervisor = SupervisorB1_IN_B2_sup_ok;
    b2_sup_status = SUPERVISOR_OK;
  } else {
    SupervisorB1_MonitorTemperature(&SupervisorB1_U.Board_Health, &temp_status);
    SupervisorB1_MonitorBattery(&SupervisorB1_U.Board_Health, &battery_status);
    switch (SupervisorB1_DW.is_MonitorFrontLeft) {
     case S_IN_FrontLeft_encoder_critical:
      if (!SupervisorB1_U.Encoder.hasNoFeedback[0]) {
        SupervisorB1_DW.is_MonitorFrontLeft = SupervisorB1_IN_FrontLeft_ok;
        SupervisorB1_B.wheel_status[0] = WHEEL_OK;
      } else if (motorFaultDetected_idx_0) {
        SupervisorB1_DW.is_MonitorFrontLeft = Sup_IN_FrontLeft_motor_critical;
        SupervisorB1_B.wheel_status[0] = WHEEL_CRITICAL_MOTOR;
      }
      break;

     case Sup_IN_FrontLeft_motor_critical:
      break;

     default:
      /* case IN_FrontLeft_ok: */
      if (SupervisorB1_U.Encoder.hasNoFeedback[0]) {
        SupervisorB1_DW.is_MonitorFrontLeft = S_IN_FrontLeft_encoder_critical;
        SupervisorB1_B.wheel_status[0] = WHEEL_DEGRADED_ENCODER;
      }
      break;
    }

    switch (SupervisorB1_DW.is_MonitorFrontRight) {
     case IN_FrontRight_encoder_critical:
      if (!SupervisorB1_U.Encoder.hasNoFeedback[1]) {
        SupervisorB1_DW.is_MonitorFrontRight = SupervisorB1_IN_FrontRight_ok;
        SupervisorB1_B.wheel_status[1] = WHEEL_OK;
      } else if (motorFaultDetected_idx_1) {
        SupervisorB1_DW.is_MonitorFrontRight = Su_IN_FrontRight_motor_critical;
        SupervisorB1_B.wheel_status[1] = WHEEL_CRITICAL_MOTOR;
      }
      break;

     case Su_IN_FrontRight_motor_critical:
      break;

     default:
      /* case IN_FrontRight_ok: */
      if (SupervisorB1_U.Encoder.hasNoFeedback[1]) {
        SupervisorB1_DW.is_MonitorFrontRight = IN_FrontRight_encoder_critical;
        SupervisorB1_B.wheel_status[1] = WHEEL_DEGRADED_ENCODER;
      }
      break;
    }

    switch (SupervisorB1_DW.is_MonitorRearLeft) {
     case Su_IN_RearLeft_encoder_critical:
      if (!SupervisorB1_U.Encoder.hasNoFeedback[2]) {
        SupervisorB1_DW.is_MonitorRearLeft = SupervisorB1_IN_RearLeft_ok;
        SupervisorB1_B.wheel_status[2] = WHEEL_OK;
      } else if (motorFaultDetected_idx_2) {
        SupervisorB1_DW.is_MonitorRearLeft = Supe_IN_RearLeft_motor_critical;
        SupervisorB1_B.wheel_status[2] = WHEEL_CRITICAL_MOTOR;
      }
      break;

     case Supe_IN_RearLeft_motor_critical:
      break;

     default:
      /* case IN_RearLeft_ok: */
      if (SupervisorB1_U.Encoder.hasNoFeedback[2]) {
        SupervisorB1_DW.is_MonitorRearLeft = Su_IN_RearLeft_encoder_critical;
        SupervisorB1_B.wheel_status[2] = WHEEL_DEGRADED_ENCODER;
      }
      break;
    }

    switch (SupervisorB1_DW.is_MonitorRearRight) {
     case S_IN_RearRight_encoder_critical:
      if (!SupervisorB1_U.Encoder.hasNoFeedback[3]) {
        SupervisorB1_DW.is_MonitorRearRight = SupervisorB1_IN_RearRight_ok;
        SupervisorB1_B.wheel_status[3] = WHEEL_OK;
      } else if (motorFaultDetected_idx_3) {
        SupervisorB1_DW.is_MonitorRearRight = Sup_IN_RearRight_motor_critical;
        SupervisorB1_B.wheel_status[3] = WHEEL_CRITICAL_MOTOR;
      }
      break;

     case Sup_IN_RearRight_motor_critical:
      break;

     default:
      /* case IN_RearRight_ok: */
      if (SupervisorB1_U.Encoder.hasNoFeedback[3]) {
        SupervisorB1_DW.is_MonitorRearRight = S_IN_RearRight_encoder_critical;
        SupervisorB1_B.wheel_status[3] = WHEEL_DEGRADED_ENCODER;
      }
      break;
    }

    switch (SupervisorB1_DW.is_MonitorBoard2Supervisor) {
     case SupervisorB1_IN_B2_sup_critical:
      b2_sup_status = SUPERVISOR_CRITICAL;
      if (SupervisorB1_DW.degraded) {
        SupervisorB1_DW.durationCounter_1_i = 0U;
      }

      if (SupervisorB1_DW.durationCounter_1_i > 50U) {
        SupervisorB1_DW.is_MonitorBoard2Supervisor = SupervisorB1_IN_B2_sup_ok;
        b2_sup_status = SUPERVISOR_OK;
      } else {
        SupervisorB1_DW.degraded = Supe_isCommDegradedByMeanPeriod
          (SupervisorB1_U.last_valid_b2_ms, 40.0);
        if (SupervisorB1_DW.degraded) {
          SupervisorB1_DW.durationCounter_1_i = 0U;
          SupervisorB1_DW.durationCounter_1_g = 0U;
        }
      }
      break;

     case SupervisorB1_IN_B2_sup_degraded:
      b2_sup_status = SUPERVISOR_DEGRADED;
      if (SupervisorB1_DW.degraded) {
        SupervisorB1_DW.durationCounter_1_g = 0U;
      }

      if (SupervisorB1_DW.durationCounter_1_g > 50U) {
        SupervisorB1_DW.is_MonitorBoard2Supervisor = SupervisorB1_IN_B2_sup_ok;
        b2_sup_status = SUPERVISOR_OK;
      } else {
        qY = SupervisorB1_U.now_ms -
          /*MW:operator MISRA2012:D4.1 CERT-C:INT30-C 'Justifying MISRA C rule violation'*/
          /*MW:OvSatOk*/ SupervisorB1_U.last_valid_b2_ms;
        if (qY > SupervisorB1_U.now_ms) {
          qY = 0U;
        }

        if (qY > 120U) {
          SupervisorB1_DW.durationCounter_1_i = 0U;
          SupervisorB1_DW.is_MonitorBoard2Supervisor =
            SupervisorB1_IN_B2_sup_critical;
          b2_sup_status = SUPERVISOR_CRITICAL;
        } else {
          SupervisorB1_DW.degraded = Supe_isCommDegradedByMeanPeriod
            (SupervisorB1_U.last_valid_b2_ms, 40.0);
          if (SupervisorB1_DW.degraded) {
            SupervisorB1_DW.durationCounter_1_i = 0U;
            SupervisorB1_DW.durationCounter_1_g = 0U;
          }
        }
      }
      break;

     default:
      /* case IN_B2_sup_ok: */
      b2_sup_status = SUPERVISOR_OK;
      if (SupervisorB1_DW.degraded) {
        SupervisorB1_DW.durationCounter_1_g = 0U;
        SupervisorB1_DW.is_MonitorBoard2Supervisor =
          SupervisorB1_IN_B2_sup_degraded;
        b2_sup_status = SUPERVISOR_DEGRADED;
      } else {
        qY = SupervisorB1_U.now_ms -
          /*MW:operator MISRA2012:D4.1 CERT-C:INT30-C 'Justifying MISRA C rule violation'*/
          /*MW:OvSatOk*/ SupervisorB1_U.last_valid_b2_ms;
        if (qY > SupervisorB1_U.now_ms) {
          qY = 0U;
        }

        if (qY > 120U) {
          SupervisorB1_DW.durationCounter_1_i = 0U;
          SupervisorB1_DW.is_MonitorBoard2Supervisor =
            SupervisorB1_IN_B2_sup_critical;
          b2_sup_status = SUPERVISOR_CRITICAL;
        } else {
          SupervisorB1_DW.degraded = Supe_isCommDegradedByMeanPeriod
            (SupervisorB1_U.last_valid_b2_ms, 40.0);
          if (SupervisorB1_DW.degraded) {
            SupervisorB1_DW.durationCounter_1_i = 0U;
            SupervisorB1_DW.durationCounter_1_g = 0U;
          }
        }
      }
      break;
    }
  }

  if ((SupervisorB1_U.Board_Health.temperature_degC < 50.0F) ||
      (SupervisorB1_U.Board_Health.temperature_degC > 0.0F)) {
    SupervisorB1_DW.durationCounter_1++;
    SupervisorB1_DW.durationCounter_1_c++;
    SupervisorB1_DW.durationCounter_1_k++;
  } else {
    SupervisorB1_DW.durationCounter_1 = 0U;
    SupervisorB1_DW.durationCounter_1_c = 0U;
    SupervisorB1_DW.durationCounter_1_k = 0U;
  }

  if ((SupervisorB1_U.Board_Health.temperature_degC > 55.0F) ||
      (SupervisorB1_U.Board_Health.temperature_degC < -5.0F)) {
    SupervisorB1_DW.durationCounter_1_p++;
  } else {
    SupervisorB1_DW.durationCounter_1_p = 0U;
  }

  if ((SupervisorB1_U.Board_Health.temperature_degC > 65.0F) ||
      (SupervisorB1_U.Board_Health.temperature_degC < -15.0F)) {
    SupervisorB1_DW.durationCounter_2++;
  } else {
    SupervisorB1_DW.durationCounter_2 = 0U;
  }

  if (SupervisorB1_U.Board_Health.battery_pct > 25.0F) {
    SupervisorB1_DW.durationCounter_1_kv++;
    SupervisorB1_DW.durationCounter_1_d++;
  } else {
    SupervisorB1_DW.durationCounter_1_kv = 0U;
    SupervisorB1_DW.durationCounter_1_d = 0U;
  }

  if (SupervisorB1_U.Board_Health.battery_pct < 23.0F) {
    SupervisorB1_DW.durationCounter_1_e++;
  } else {
    SupervisorB1_DW.durationCounter_1_e = 0U;
  }

  if (SupervisorB1_U.Board_Health.battery_pct > 25.0F) {
    SupervisorB1_DW.durationCounter_1_m++;
  } else {
    SupervisorB1_DW.durationCounter_1_m = 0U;
  }

  if (SupervisorB1_U.Board_Health.battery_pct < 15.0F) {
    SupervisorB1_DW.durationCounter_2_e++;
  } else {
    SupervisorB1_DW.durationCounter_2_e = 0U;
  }

  if (!SupervisorB1_DW.degraded) {
    SupervisorB1_DW.durationCounter_1_i++;
    SupervisorB1_DW.durationCounter_1_g++;
  } else {
    SupervisorB1_DW.durationCounter_1_i = 0U;
    SupervisorB1_DW.durationCounter_1_g = 0U;
  }

  /* End of Chart: '<Root>/Monitor Board Status' */

  /* MATLAB Function: '<Root>/Board 1 fault masks' */
  crit_mask = 0;
  degr_mask = 0;
  switch (temp_status) {
   case TEMP_HEALTH_CRITICAL:
    crit_mask = 1;
    break;

   case TEMP_HEALTH_DEGRADED:
    degr_mask = 1;
    break;
  }

  switch (battery_status) {
   case BATTERY_HEALTH_CRITICAL:
    crit_mask = (int32_T)((uint32_T)crit_mask | 2U);
    break;

   case BATTERY_HEALTH_DEGRADED:
    degr_mask = (int32_T)((uint32_T)degr_mask | 2U);
    break;
  }

  switch (SupervisorB1_B.rx_status) {
   case RX_CRITICAL:
    crit_mask = (int32_T)((uint32_T)crit_mask | 4U);
    break;

   case RX_DEGRADED:
    degr_mask = (int32_T)((uint32_T)degr_mask | 4U);
    break;
  }

  switch (SupervisorB1_B.wheel_status[0]) {
   case WHEEL_CRITICAL_MOTOR:
    crit_mask = (int32_T)((uint32_T)crit_mask | 8U);
    break;

   case WHEEL_DEGRADED_ENCODER:
    degr_mask = (int32_T)((uint32_T)degr_mask | 8U);
    break;
  }

  switch (SupervisorB1_B.wheel_status[1]) {
   case WHEEL_CRITICAL_MOTOR:
    crit_mask = (int32_T)((uint32_T)crit_mask | 16U);
    break;

   case WHEEL_DEGRADED_ENCODER:
    degr_mask = (int32_T)((uint32_T)degr_mask | 16U);
    break;
  }

  switch (SupervisorB1_B.wheel_status[2]) {
   case WHEEL_CRITICAL_MOTOR:
    crit_mask = (int32_T)((uint32_T)crit_mask | 32U);
    break;

   case WHEEL_DEGRADED_ENCODER:
    degr_mask = (int32_T)((uint32_T)degr_mask | 32U);
    break;
  }

  switch (SupervisorB1_B.wheel_status[3]) {
   case WHEEL_CRITICAL_MOTOR:
    crit_mask = (int32_T)((uint32_T)crit_mask | 64U);
    break;

   case WHEEL_DEGRADED_ENCODER:
    degr_mask = (int32_T)((uint32_T)degr_mask | 64U);
    break;
  }

  switch (b2_sup_status) {
   case SUPERVISOR_CRITICAL:
    crit_mask = (int32_T)((uint32_T)crit_mask | 128U);
    break;

   case SUPERVISOR_DEGRADED:
    degr_mask = (int32_T)((uint32_T)degr_mask | 128U);
    break;
  }

  /* Chart: '<Root>/Check rover safety state' incorporates:
   *  Inport: '<Root>/Board2_Data'
   *  MATLAB Function: '<Root>/Board 1 fault masks'
   */
  if (SupervisorB1_DW.is_active_c7_SupervisorB1 == 0) {
    SupervisorB1_DW.is_active_c7_SupervisorB1 = 1U;
    SupervisorB1_DW.is_c7_SupervisorB1 = SupervisorB_IN_Rover_Safe_State;
    rtb_rover_safety_state = SAFETY_OK;
  } else {
    switch (SupervisorB1_DW.is_c7_SupervisorB1) {
     case Supervi_IN_Rover_Critical_State:
      rtb_rover_safety_state = SAFETY_CRITICAL;
      if ((crit_mask == 0) && (SupervisorB1_U.Board2_Data.payload.critical_mask ==
           0U)) {
        if ((degr_mask == 0) &&
            (SupervisorB1_U.Board2_Data.payload.degraded_mask == 0U)) {
          SupervisorB1_DW.is_c7_SupervisorB1 = SupervisorB_IN_Rover_Safe_State;
          rtb_rover_safety_state = SAFETY_OK;
        } else if ((degr_mask != 0) ||
                   (SupervisorB1_U.Board2_Data.payload.degraded_mask != 0U)) {
          SupervisorB1_DW.is_c7_SupervisorB1 = Supervi_IN_Rover_Degraded_State;
          rtb_rover_safety_state = SAFETY_DEGRADED;
        }
      }
      break;

     case Supervi_IN_Rover_Degraded_State:
      rtb_rover_safety_state = SAFETY_DEGRADED;
      if ((degr_mask == 0) && (SupervisorB1_U.Board2_Data.payload.degraded_mask ==
           0U)) {
        SupervisorB1_DW.is_c7_SupervisorB1 = SupervisorB_IN_Rover_Safe_State;
        rtb_rover_safety_state = SAFETY_OK;
      } else if ((crit_mask != 0) ||
                 (SupervisorB1_U.Board2_Data.payload.critical_mask != 0U)) {
        SupervisorB1_DW.is_c7_SupervisorB1 = Supervi_IN_Rover_Critical_State;
        rtb_rover_safety_state = SAFETY_CRITICAL;
      }
      break;

     default:
      /* case IN_Rover_Safe_State: */
      rtb_rover_safety_state = SAFETY_OK;
      if ((crit_mask != 0) || (SupervisorB1_U.Board2_Data.payload.critical_mask
           != 0U)) {
        SupervisorB1_DW.is_c7_SupervisorB1 = Supervi_IN_Rover_Critical_State;
        rtb_rover_safety_state = SAFETY_CRITICAL;
      } else if ((degr_mask != 0) ||
                 (SupervisorB1_U.Board2_Data.payload.degraded_mask != 0U)) {
        SupervisorB1_DW.is_c7_SupervisorB1 = Supervi_IN_Rover_Degraded_State;
        rtb_rover_safety_state = SAFETY_DEGRADED;
      }
      break;
    }
  }

  /* End of Chart: '<Root>/Check rover safety state' */

  /* MATLAB Function: '<Root>/Set actuation command' */
  V_MAX = 1.0;
  OMEGA_MAX = 1.0F;
  V_MAX_MANEUVER = 0.6;
  OMEGA_GO_LEFT = 0.2;
  OMEGA_GO_RIGHT = -0.2;
  switch (rtb_rover_safety_state) {
   case SAFETY_DEGRADED:
    V_MAX = 0.5;
    OMEGA_MAX = 0.5F;
    V_MAX_MANEUVER = 0.3;
    OMEGA_GO_LEFT = 0.1;
    OMEGA_GO_RIGHT = -0.1;
    break;

   case SAFETY_CRITICAL:
    V_MAX = 0.0;
    OMEGA_MAX = 0.0F;
    V_MAX_MANEUVER = 0.0;
    OMEGA_GO_LEFT = 0.0;
    OMEGA_GO_RIGHT = 0.0;
    SupervisorB1_DW.rotating = false;
    SupervisorB1_DW.frame_inverted = false;
    SupervisorB1_DW.targetAngle = 0.0F;
    break;
  }

  /* Outport: '<Root>/v_ref' incorporates:
   *  MATLAB Function: '<Root>/Set actuation command'
   */
  SupervisorB1_Y.v_ref = 0.0F;

  /* Outport: '<Root>/omega_ref' incorporates:
   *  MATLAB Function: '<Root>/Set actuation command'
   */
  SupervisorB1_Y.omega_ref = 0.0F;

  /* MATLAB Function: '<Root>/Set actuation command' incorporates:
   *  Inport: '<Root>/Board2_Data'
   */
  if ((SupervisorB1_U.Board2_Data.payload.command == CMD_ESTOP) ||
      (SupervisorB1_U.Board2_Data.payload.command == CMD_STOP)) {
    SupervisorB1_DW.rotating = false;
    SupervisorB1_DW.frame_inverted = false;
  } else {
    v_user = SupervisorB1_U.Board2_Data.payload.y_norm * (real32_T)V_MAX;
    omega_user = SupervisorB1_U.Board2_Data.payload.x_norm * OMEGA_MAX;
    if ((!SupervisorB1_DW.rotating) && (!SupervisorB1_DW.frame_inverted) &&
        (SupervisorB1_U.Board2_Data.payload.y_norm < -0.6) &&
        (rtb_rover_safety_state != SAFETY_CRITICAL)) {
      if (SupervisorB1_U.Board2_Data.payload.yaw + 180.0F > 360.0F) {
        SupervisorB1_DW.targetAngle = (SupervisorB1_U.Board2_Data.payload.yaw +
          180.0F) - 360.0F;
      } else {
        SupervisorB1_DW.targetAngle = SupervisorB1_U.Board2_Data.payload.yaw +
          180.0F;
      }

      SupervisorB1_DW.rotating = true;
    }

    guard1 = false;
    if (SupervisorB1_DW.rotating) {
      if (!(fabsf(SupervisorB1_mod((SupervisorB1_DW.targetAngle -
              SupervisorB1_U.Board2_Data.payload.yaw) + 180.0F) - 180.0F) < 10.0F))
      {
        v_user = SupervisorB1_mod((SupervisorB1_U.Board2_Data.payload.yaw -
          SupervisorB1_DW.targetAngle) + 360.0F);
        if (rtIsNaNF(v_user)) {
          omega_user = (rtNaNF);
        } else if (v_user < 0.0F) {
          omega_user = -1.0F;
        } else {
          omega_user = (real32_T)(v_user > 0.0F);
        }

        /* Outport: '<Root>/omega_ref' */
        if (fabsf(v_user) > 45.0F) {
            SupervisorB1_Y.omega_ref = OMEGA_MAX * omega_user;
        } else {
            SupervisorB1_Y.omega_ref =
                fminf(OMEGA_MAX, fabsf(fmaxf(v_user,15.0f)) * 0.01F) * omega_user;
        }
      } else {
        SupervisorB1_DW.rotating = false;
        SupervisorB1_DW.frame_inverted = true;
        guard1 = true;
      }
    } else {
      guard1 = true;
    }

    if (guard1) {
      if (SupervisorB1_DW.frame_inverted) {
        if (SupervisorB1_U.Board2_Data.payload.y_norm >= 0.0F) {
          SupervisorB1_DW.frame_inverted = false;
        } else {
          v_user = -v_user;
        }
      }

      if (v_user > 0.0F) {
        switch (SupervisorB1_U.Board2_Data.payload.command) {
         case CMD_AVOID_LEFT:
          /* Outport: '<Root>/v_ref' */
          SupervisorB1_Y.v_ref = v_user;

          /* Outport: '<Root>/omega_ref' */
          SupervisorB1_Y.omega_ref = fminf(omega_user, 0.0F);
          break;

         case CMD_AVOID_RIGHT:
          /* Outport: '<Root>/v_ref' */
          SupervisorB1_Y.v_ref = v_user;

          /* Outport: '<Root>/omega_ref' */
          SupervisorB1_Y.omega_ref = fmaxf(omega_user, 0.0F);
          break;

         case CMD_GO_LEFT:
          /* Outport: '<Root>/v_ref' */
          SupervisorB1_Y.v_ref = fminf(v_user, (real32_T)V_MAX_MANEUVER);

          /* Outport: '<Root>/omega_ref' */
          SupervisorB1_Y.omega_ref = fmaxf(omega_user, (real32_T)OMEGA_GO_LEFT);
          break;

         case CMD_GO_RIGHT:
          /* Outport: '<Root>/v_ref' */
          SupervisorB1_Y.v_ref = fminf(v_user, (real32_T)V_MAX_MANEUVER);

          /* Outport: '<Root>/omega_ref' */
          SupervisorB1_Y.omega_ref = fminf(omega_user, (real32_T)OMEGA_GO_RIGHT);
          break;

         case CMD_NORMAL:
          /* Outport: '<Root>/v_ref' */
          SupervisorB1_Y.v_ref = v_user;

          /* Outport: '<Root>/omega_ref' */
          SupervisorB1_Y.omega_ref = omega_user;
          break;
        }
      } else if (SupervisorB1_U.Board2_Data.payload.command == CMD_NORMAL) {
        /* Outport: '<Root>/omega_ref' */
        SupervisorB1_Y.omega_ref = omega_user;
      }
    }
  }

  /* Outport: '<Root>/critical_mask' incorporates:
   *  MATLAB Function: '<Root>/Board 1 fault masks'
   */
  SupervisorB1_Y.critical_mask = (uint32_T)crit_mask;

  /* Outport: '<Root>/degraded_mask' incorporates:
   *  MATLAB Function: '<Root>/Board 1 fault masks'
   */
  SupervisorB1_Y.degraded_mask = (uint32_T)degr_mask;

  /* Update for UnitDelay: '<Root>/Unit Delay' */
  SupervisorB1_DW.UnitDelay_DSTATE[0] = SupervisorB1_B.wheel_status[0];
  SupervisorB1_DW.UnitDelay_DSTATE[1] = SupervisorB1_B.wheel_status[1];
  SupervisorB1_DW.UnitDelay_DSTATE[2] = SupervisorB1_B.wheel_status[2];
  SupervisorB1_DW.UnitDelay_DSTATE[3] = SupervisorB1_B.wheel_status[3];
}

/* Model initialize function */
void SupervisorB1_initialize(void)
{
  /* (no initialization code required) */
}

/* Model terminate function */
void SupervisorB1_terminate(void)
{
  /* (no terminate code required) */
}

/*
 * File trailer for generated code.
 *
 * [EOF]
 */
