/*
 * log_format.c
 *
 *  Created on: Jan 19, 2026
 *      Author: Sterm
 */

#include "log/log_format.h"
#include <stdio.h>
#include <string.h>
#include "snapshot/supervisor_snapshot.h"

#include "shared_resources/board1_faults.h"
#include "shared_resources/board2_faults.h"
static const char *CommUnpackStatusToStr(CommUnpackStatus_t s)
{
    switch (s)
    {
        case COMM_UNPACK_OK:   return "OK";
        case COMM_UNPACK_NULL: return "NULL";
        case COMM_UNPACK_LEN:  return "LEN";
        case COMM_UNPACK_CRC:  return "CRC";
        default:               return "UNK";
    }
}

static const char *B1FaultFlagsToStr(uint32_t flags)
{
    static char buf[64];

    if (flags == FAULT_NONE)
    {
        strcpy(buf, "NONE");
        return buf;
    }

    buf[0] = '\0';

    if (flags & FAULT_TEMP)      strcat(buf, "TEMP-");
    if (flags & FAULT_BATT)      strcat(buf, "BATT-");
    if (flags & FAULT_RX)       strcat(buf, "RX-");
    if (flags & FAULT_WHEEL_FL) strcat(buf, "FL-");
    if (flags & FAULT_WHEEL_FR)          strcat(buf, "FR-");
    if (flags & FAULT_WHEEL_RL)    strcat(buf, "RL-");
    if (flags & FAULT_WHEEL_RR)            strcat(buf, "RR-");
    if (flags & FAULT_B2_SUP)            strcat(buf, "B2SUP-");


    /* rimuove l'ultimo '|' */
    buf[strlen(buf) - 1] = '\0';

    return buf;
}

static const char *B2FaultFlagsToStr(uint32_t flags)
{
    static char buf[64];

    if (flags == FAULT_NONE)
    {
        strcpy(buf, "NONE");
        return buf;
    }

    buf[0] = '\0';

    if (flags & FAULT_BLE)      strcat(buf, "BLE-");
    if (flags & FAULT_IMU)      strcat(buf, "IMU-");
    if (flags & FAULT_B1_SUP)       strcat(buf, "B1SUP-");



    /* rimuove l'ultimo '|' */
    buf[strlen(buf) - 1] = '\0';

    return buf;
}

void Log_FormatSnapshot(char *buf,
                        unsigned buf_len,
                        const EncoderSnapshot_t *enc,
                        const BoardHealthSnapshot_t *bh,
						const RxSnapshot_t *rx)
{
    if (!buf || !enc || !bh || !rx)
        return;

    static SupervisorSnapshot_t sup;
    SupervisorSnapshot_Read(&sup);
    snprintf(
        buf, buf_len,
        "[SNAPSHOT]\r\n"
        "ENC t = %u | FL=%.2f (t: %u) | FR=%.2f (t: %u) | RL=%.2f (t: %u) | RR=%.2f (t: %u)\r\n"
        "BOARD HEALTH t = %u | Temp: %.2f (t: %u) | BATT=%.2f%% (t: %u)\r\n"
        "RX t = %u | last=%s | valid_t=%u\r\n"
        "RX PAYLOAD | x=%.2f | y=%.2f | cmd=%u | criticalB2=%s | degradedB2=%s | alive=%lu\r\n"
        "criticalB1=%s | degradedB1=%s\r\n\r\n",

        (unsigned)enc->task_last_run_ms,
        enc->wheel_speed_rpm[0], (unsigned)enc->data_last_valid_ms[0],
        enc->wheel_speed_rpm[1], (unsigned)enc->data_last_valid_ms[1],
        enc->wheel_speed_rpm[2], (unsigned)enc->data_last_valid_ms[2],
        enc->wheel_speed_rpm[3], (unsigned)enc->data_last_valid_ms[3],

        (unsigned)bh->task_last_run_ms,
        bh->temperature_degC,
        (unsigned)bh->temp_last_valid_ms,
        bh->battery_pct,
        (unsigned)bh->batt_last_valid_ms,

        (unsigned)rx->task_last_run_ms,
        CommUnpackStatusToStr(rx->last_event),
        (unsigned)rx->data_last_valid_ms,

        rx->payload.x_norm,
        rx->payload.y_norm,
        rx->payload.command,
		B2FaultFlagsToStr(rx->payload.critical_mask),
		B2FaultFlagsToStr(rx->payload.degraded_mask),
        rx->payload.alive_counter,
		B1FaultFlagsToStr(sup.critical_mask),
		B1FaultFlagsToStr(sup.degraded_mask)
    );

}

