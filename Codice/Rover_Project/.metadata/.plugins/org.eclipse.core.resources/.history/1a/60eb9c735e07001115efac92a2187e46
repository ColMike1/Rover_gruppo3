/*
 * supervisor_task.c
 *
 *  Created on: Feb 1, 2026
 *      Author: Sterm
 */


#include "supervisor/supervisor_task.h"

#include "snapshot/ble_controller_snapshot.h"
#include "snapshot/imu_snapshot.h"
#include "snapshot/sonar_snapshot.h"
#include "snapshot/rx_snapshot.h"
#include "snapshot/supervisor_snapshot.h"

#include "shared_resources/supervisor_command.h"
#include "shared_resources/imu_coherence_status.h"

#include "SupervisorB2.h"
#include "rtwtypes.h"

#include "cmsis_os2.h"

void Supervisor_TaskInit(void){
	SupervisorB2_initialize();
}

void Supervisor_TaskStep(void)
{
	static SonarSnapshot_t son;
	static IMUSnapshot_t imu;
	static BleControllerSnapshot_t ble;
	static RxSnapshot_t rx;
	static SupervisorSnapshot_t sup;
	static uint8_t last_sup_counter = 0;
	static uint32_t last_sup_update_ms = 0;

	SonarSnapshot_Read(&son);
	IMUSnapshot_Read(&imu);
	BleControllerSnapshot_Read(&ble);
	RxSnapshot_Read(&rx);

	uint32_t now = osKernelGetTickCount();

	CommPayloadB1_t payload = rx.payload;

	if (payload.alive_counter != last_sup_counter) {
	    last_sup_counter = payload.alive_counter;
	    last_sup_update_ms = now;
	}

	SupervisorB2_U.Board1_Data= rx;
	SupervisorB2_U.BLE = ble;
	SupervisorB2_U.IMU = imu;
	SupervisorB2_U.Sonars = son;
	SupervisorB2_U.last_valid_b1_ms = last_sup_update_ms;
	SupervisorB2_U.now_ms = now;

	SupervisorB2_step();

	sup.critical_mask = SupervisorB2_Y.critical_mask;
	sup.degraded_mask = SupervisorB2_Y.degraded_mask;
	sup.command = SupervisorB2_Y.B2Decision;
	sup.imu_coherence = SupervisorB2_Y.imu_coherence_status;

	sup.alive_counter ++;
	sup.task_last_run_ms = now;


	SupervisorSnapshot_Write(&sup);

}
