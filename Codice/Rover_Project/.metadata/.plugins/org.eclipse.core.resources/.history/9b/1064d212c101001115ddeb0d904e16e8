/*
 * actuation_task.c
 *
 *  Created on: Jan 12, 2026
 *      Author: Sterm
 */


#include "actuation/actuation.h"
#include "snapshot/supervisor_snapshot.h"
#include "snapshot/encoder_snapshot.h"
#include <control/control_law.h>
#include "cmsis_os2.h"
#include <math.h>
#include <stdio.h>
/* === Parametri === */
#define ACTUATION_MAX_VOLTAGE   12.0f

#define VOLTAGE_DEADZONE 0.6f



void Actuation_Init(void)
{
    Sabertooth_Init();
}


/* === Step periodico === */
void Actuation_Step(ControlOutput_t cmd)
{

	static SupervisorSnapshot_t sup;
	static EncoderSnapshot_t enc;

    /* === Read snapshots === */
    SupervisorSnapshot_Read(&sup);
    EncoderSnapshot_Read(&enc);


    /* === Safety gate === */
    //In realtà se sup mi dice ESTOP

    if ( sup.critical_mask!= 0U)
    {
        Sabertooth_ApplyOutputs(0, 0, 0, 0);
        return;
    }


    float u_sx_a = cmd.u_sx_a;
    float u_dx_a = cmd.u_dx_a;
    float u_sx_p = cmd.u_sx_p;
    float u_dx_p = cmd.u_dx_p;

    //Quando un encoder è stuck e copia il comando di attuazione di un'altra ruota può succedere che la ruota con encoder sano si fermi ma applicando
    //lo stesso comando ad un altra ruota (quella che segue) questa continui a muoversi.
    //Questo accade perchè tutti i motori hanno deadzone diverse. Per questo motivo se il comando è minore di
    // max(deadzone_fl, deadzone_fr, deadzone_rl, deadzone_rr) allora il motore va fermato (per evitare che continui a ruotare).

    if( (fabs(u_sx_a) < VOLTAGE_DEADZONE) && enc.hasNoFeedback[0])
    	u_sx_a = 0;

    if( (fabs(u_dx_a) < VOLTAGE_DEADZONE) && enc.hasNoFeedback[1])
    	u_dx_a = 0;

    if( (fabs(u_sx_p) < VOLTAGE_DEADZONE) && enc.hasNoFeedback[2])
    	u_sx_p = 0;

    if( (fabs(u_dx_p) < VOLTAGE_DEADZONE) && enc.hasNoFeedback[3])
    	u_dx_p = 0;


    if (u_sx_a >  ACTUATION_MAX_VOLTAGE) u_sx_a =  ACTUATION_MAX_VOLTAGE;
    if (u_sx_a < -ACTUATION_MAX_VOLTAGE) u_sx_a = -ACTUATION_MAX_VOLTAGE;
    if (u_dx_a >  ACTUATION_MAX_VOLTAGE) u_dx_a =  ACTUATION_MAX_VOLTAGE;
    if (u_dx_a < -ACTUATION_MAX_VOLTAGE) u_dx_a = -ACTUATION_MAX_VOLTAGE;
    if (u_sx_p >  ACTUATION_MAX_VOLTAGE) u_sx_p =  ACTUATION_MAX_VOLTAGE;
    if (u_sx_p < -ACTUATION_MAX_VOLTAGE) u_sx_p = -ACTUATION_MAX_VOLTAGE;
    if (u_dx_p >  ACTUATION_MAX_VOLTAGE) u_dx_p =  ACTUATION_MAX_VOLTAGE;
    if (u_dx_p < -ACTUATION_MAX_VOLTAGE) u_dx_p = -ACTUATION_MAX_VOLTAGE;



    /* === Attuazione HW === */
    Sabertooth_ApplyOutputs(u_sx_a, u_dx_a, u_sx_p, u_dx_p);


}
