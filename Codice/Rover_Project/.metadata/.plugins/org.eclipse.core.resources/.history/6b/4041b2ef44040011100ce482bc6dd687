/*
 * encoder_snapshot.c
 *
 *  Created on: Jan 8, 2026
 *      Author: Sterm
 */


#include "snapshot/encoder_snapshot.h"
#include "cmsis_os2.h"

/* Snapshot storage */
static EncoderSnapshot_t snapshot;

/* Mutex */
static uint8_t snapshot_mutex_cb[osMutexCbSize];

static const osMutexAttr_t snapshot_mutex_attr = {
    .name = "EncoderSnapshotMutex",
    .cb_mem = snapshot_mutex_cb,
    .cb_size = sizeof(snapshot_mutex_cb),
	.attr_bits = osMutexPrioInherit | osMutexRobust
};

static osMutexId_t snapshot_mutex;


static void Snapshot_MutexInit(void)
{
    if (snapshot_mutex == NULL)
    {
        snapshot_mutex = osMutexNew(NULL);
    }
}

/* ===== Writer API ===== */
void EncoderSnapshot_Write(const EncoderSnapshot_t *src)
{
  if (src == NULL)
    return;

  Snapshot_MutexInit();

  osMutexAcquire(snapshot_mutex, osWaitForever);
  snapshot = *src;   /* struct copy atomica */
  osMutexRelease(snapshot_mutex);
}

/* ===== Reader API ===== */
void EncoderSnapshot_Read(EncoderSnapshot_t *dst)
{
  if (dst == NULL)
    return;

  Snapshot_MutexInit();

  osMutexAcquire(snapshot_mutex, osWaitForever);
  *dst = snapshot;   /* struct copy atomica */
  osMutexRelease(snapshot_mutex);
}
