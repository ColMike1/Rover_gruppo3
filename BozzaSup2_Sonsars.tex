\documentclass[12pt, a4paper]{article} 
\usepackage{graphicx}
\usepackage{float}
\usepackage{subcaption}
\graphicspath{ {./images/} }

\title{Supervisori}
\date{Febbraio 2026}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}
\maketitle
\newpage
\tableofcontents
\listoffigures
\newpage

\section{Acquisizione segnali Board 2} 
\subsection{\textbf{HC-SR04} - Sensore ad ultrasuoni}
La Board 2 è equipaggiata con tre sensori ad ultrasuoni \textbf{HC-SR04} per il rilevamento di ostacoli. 
Questi sono disposti a 45° l'uno dall'altro, come mostrato in Figura~\ref{fig:sensori}.




\begin{figure}[ht]
    \centering
    \includegraphics[width=0.6\textwidth]{images/Sonars/disposizioneSonar} 
    \caption{Disposizione dei sensori sulla Board 2.}
    \label{fig:sensori}
\end{figure}

Ogni sensore emette onde sonore ad alta frequenza e produce segnali di tipo onda quadra la cui durata è proporzionale all'ostacolo rilevato. 
\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\textwidth]{images/Sonars/segnale_sonar_3m}
    \caption{Segnale generato dal sensore HC-SR04 in presenza di un ostacolo a 3 metri di distanza.}
    \label{fig:segnale_sonar}
\end{figure}
La board2, rilevando i fronti di salita e discesa, può misurare l'intervallo tra i due fronti e utilizzare questa informazione per calcolare
la distanza dall'ostacolo e prendere decisioni appropriate per evitare collisioni.

\subsubsection*{Utilizzo DMA per la lettura dei segnali}
Per ottimizzare la lettura dei segnali dai sensori ad ultrasuoni, la Board 2 utilizza il Direct Memory Access (DMA).
Il DMA consente di trasferire i dati direttamente tra la periferica (i sensori ad ultrasuoni) e la memoria, senza l'intervento della CPU.
Il timer utilizzato è il $Timer 1$, con i canali $1$, $2$ e $3$ configurati in modalità \textit{input capture} per catturare i fronti di salita e discesa generati dai tre sensori.
\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\textwidth]{images/Sonars/configurazione_timIC_sonar}
    \caption{Configurazione del DMA per la lettura dei segnali dai sensori.}
    \label{fig:dma_sonar}
\end{figure}

Ogni canale del DMA è configurato in modalità interrupt, permettendo, alla fine della rilevazione dei due fronti (salita e discesa), di eseguire una $Callback$ che imposta dei flag a 1. 
Questo flag indica che i fronti sono stati rilevati e che la distanza dall'ostacolo può essere calcolata. In totale vengono eseguite solo $3$ callback, attivate solo quando uno specifico 
canale DMA ha terminato la lettura di entrambi i fronti. La Figura~\ref{fig:callback_sonar} mostra un esempio di callback eseguita al termine della rilevazione dei fronti.
\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\textwidth]{images/Sonars/callback_sonar}
    \caption{Callback eseguita al termine della rilevazione dei fronti.}
    \label{fig:callback_sonar}
\end{figure}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\section{Supervisore Board 2}
\subsection{Rilevamento ostacoli}
Come da specifiche, il comportamento del rover, in presenza di ostacoli, deve essere funzione di due condizioni principali in cui il sistema può trovarsi:
\begin{enumerate}
    \item \textit{Stato non degradato}
    \begin{itemize}
        \item \textbf{Distanza dell'ostacolo $\le$ 70 cm:} il rover deve fermarsi immediatamente per evitare collisioni.
        \item \textbf{Ostacolo a distanza $>$ 100 cm in movimento tra due sonar:} il rover deve determinare la direzione dell'ostacolo e deve deviare il 
        percorso di conseguenza in direzione del sonar che per prima ha rilveato l'ostacolo.
    \end{itemize}
    \item \textit{Stato degradato}
    \begin{itemize}
        \item \textbf{Distanza dell'ostacolo $\le$ 300 cm:} il rover deve fermarsi immediatamente per evitare collisioni.
    \end{itemize}
\end{enumerate}

In seguito verranno mostrati i chart realizzati per la gestione delle due casistiche.
\subsubsection{Gestione ostacoli con sistema in stato $non degradato$}

Il chart per la gestione degli ostacoli in stato non degradato è mostrato in Figura~\ref{fig:chart_non_degradato}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{images/SupervisoreB2/GestioneRilevamentoOstacoli/GestioneOstacoli_StatoNonDegradato}
    \caption{Chart di gestione ostacoli in stato non degradato.}
    \label{fig:chart_non_degradato}
\end{figure}

In particolare, il chart è composto da 2 stati paralleli: \textit{Sonars} e \textit{B2Decisione}

\begin{figure}[h]
    \centering
    \begin{subfigure}{0.45\textwidth}
        \includegraphics[width=\textwidth]{images/SupervisoreB2/GestioneRilevamentoOstacoli/SonarsState}
        \caption{Stato parallelo Sonars}
    \end{subfigure}
    \hfill
    \begin{subfigure}{0.45\textwidth}
        
        \includegraphics[width=\textwidth]{images/SupervisoreB2/GestioneRilevamentoOstacoli/B2DecisionState}
        \caption{Stato parallelo B2Decisione}
    \end{subfigure}
    
    \caption{Stati paralleli del chart in stato non degradato.}
    \label{fig:stati_paralleli}
\end{figure}



\begin{enumerate}
    \item \textbf{\textit{B2Decisions}}: 
        Lo stato parallelo \textit{B2Decisione} è dipendente dallo stato $Sonars$ in quanto le sue transizioni vengono attivate da segnali provenienti da $Sonars$. In base ai segnali
        ricevuti, è capace di settare la variabile di output del chart, variabile che indica la decisione presa dal supervisore.
        Quindi, in questo stato si determina l'output del chart, che è un numero che varia da $0$ a $4$.
        Le azioni possibili includono l'arresto immediato del rover o la deviazione del percorso in base alla posizione dell'ostacolo. In quest'ultimo caso, la deviazione dura fintanto che il rover non ruota
        di 45° rispetto alla direzione iniziale, verso la direzione del sonar che per primo ha rilevato l'ostacolo.
    \item \textbf{\textit{Sonars}}: 
        All'interno di questo stato parallelo sono presenti altri \textit{3} stati paralleli.
        \begin{enumerate}
            \item \textbf{\textit{distance\_70}}: Rappresenta la condizione in cui uno dei sonar rileva un ostacolo a una distanza $\leq 70$ cm.
                \begin{figure}[H]
                \centering
                \includegraphics[width=0.9\textwidth]{images/SupervisoreB2/GestioneRilevamentoOstacoli/distanceLt_70}
                \caption{Stato parallelo per la gestione di un ostacolo a distanza $\le$ 70 cm.}
                \label{fig:sonars_non_degradato}
                \end{figure}
        
        In questo stato quando uno dei sonar rileva un ostacolo a una distanza inferiore o uguale a 70 cm, viene attivata una transizione che porta allo stato di arresto immediato del rover.
        In particolare, quando un sonar rileva la presenza di un ostacolo a distanza $\leq 70$ cm, viene inviato un segnale \textbf{Emergency} allo stato parallelo \textit{B2Decisione} per fermare il rover. 
        B2Decision utilizza questo segnale per portarsi nello stato in cui l'output del chart prevede lo stop.
            
            \item \textbf{\textit{distance\_gt70 ---- timers}}: 
                Questi due stati insieme permettono il rilevamento di un ostacolo in movimento tra le coppie di sonar 
                \begin{itemize}
                    \item \textit{S1-S2} (tra sonar di sinistra e sonar centrale)
                    \item \textit{S2-S1} (tra sonar centrale e sonar di sinistra)
                    \item \textit{S2-S3} (tra sonar centrale e sonar di destra)
                    \item \textit{S3-S2} (tra sonar di destra e sonar centrale)  
                \end{itemize}
                
                \begin{figure}[H]
                    \centering
                    \includegraphics[width=0.9\textwidth]{images/SupervisoreB2/GestioneRilevamentoOstacoli/distancegt_70_and_timers}
                    \caption{Stato parallelo per la gestione di un ostacolo in movimento a distanza $>$ 70 cm.}
                    \label{fig:stati_gestione_timers}
                \end{figure}
                Nello stato \textit{distance\_gt70} sono presenti $3$ stati paralleli, \textit{Waiting\_S1}, \textit{Waiting\_S2}, \textit{Waiting\_S3}, uno per ogni sonar.
                
                Di seguito si analizza la dinamica di rilevamento di un ostacolo che si sposta dal sonar $S1$ verso il sonar $S2$.
                Tale logica è da considerarsi valida per ogni coppia di sensori precedentemente elencata. 
                
                Si assume, come condizione necessaria, l'assenza di ostacoli a una distanza inferiore a $70$ cm; in caso contrario, il sistema non procederebbe al rilevamento di oggetti in movimento.
                
                \begin{enumerate}
                    \item \textbf{Attivazione ($S1$)}: Quando il sonar $S1$ rileva un oggetto entro il range $100$–$300$ cm, la variabile $obj1Detected$ viene impostata a $1$ \textbf{(fronte di salita)}.
                    \item \textbf{Transizione e Timing}: Nel momento in cui l'oggetto esce dal campo d'azione di $S1$, la variabile $obj1Detected$ torna a $0$ \textbf{(fronte di discesa)}.
                    Contestualmente, lo stato timerSonar12 del modulo timers avvia un conteggio di $3$ secondi.
                    \item \textbf{Verifica ($S2$)}: Se il sonar $S2$ rileva l'ostacolo (sempre tra $100$ e $300$ cm) entro la finestra temporale dei $3$ secondi, viene inviato il segnale $moveToS1$ allo 
                    stato parallelo $B2Decision$. Qualora il timer scada senza alcun rilevamento da parte di $S2$, non viene trasmesso alcun segnale.
                \end{enumerate}
            \end{enumerate}
\end{enumerate}

\subsubsection{Gestione ostacoli con sistema in stato $degradato$}

Il chart per la gestione degli ostacoli in stato degradato è mostrato in Figura~\ref{fig:chart_degradato}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{images/SupervisoreB2/GestioneRilevamentoOstacoli/GestioneOstacoli_StatoDegradato}
    \caption{Chart di gestione ostacoli in stato degradato.}
    \label{fig:chart_degradato}
\end{figure}



In questo caso, la logica di gestione degli ostacoli è semplificata rispetto allo stato non degradato.
Infatti, l'unica condizione considerata è la presenza di un ostacolo a una distanza inferiore o uguale a $300$ cm.
Quando uno dei sonar rileva un ostacolo entro questo range, viene attivata una transizione che porta l'uscita del supervisore all'arresto immediato del rover.


\section{Supervisore Board 1}
\subsection{Panoramica generale -- Input e Output}
Il supervisore della Board 1 è implementato come un modulo Simulink denominato \textbf{SupervisorB1}, il cui schema a blocchi è illustrato in Figura~\ref{fig:supervisorB1_block}.
\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{images/SupervisoreB1/SupervisoreB1_simulink}
    \caption{Schema a blocchi del modulo SupervisorB1.}
    \label{fig:supervisorB1_block} 
\end{figure}
Il suo compito è quello di decidere il riferimento di velocita (\textit{v\_ref}) e di direzione (\textit{omega\_ref}) del rover, in funzione dell'elaborazione dei dati di input.

\subsubsection{Input}
I segnali in input che riceve sono:
\begin{itemize}
    \item \textbf{Board2\_Data}: rappresenta i dati provenienti dalla Board2. Quelli utilizzati dal supervisore sono:
    \begin{itemize}
        \item \textit{command}: rappresenta il comando in uscita dal supervisore della Board2, che può assumere i seguenti valori:
            \begin{figure}[H]
                \centering
                \includegraphics[width=0.3\textwidth]{images/SupervisoreB1/CMD\_BOARD2}
                \caption{Comandi in uscita dal supervisore della Board2.}
                \label{fig:comandi_b2}
            \end{figure}
        \item \textit{x\_norm \emph{\&} y\_norm}: rappresenta il comando utente proveniente dal joistick.
        \item \textit{yaw}: rappresenta l'angolo di orientamento del rover, calcolato a partire dai dati provenienti dalla Board2.
        \item \textit{imu\_cohearence\_status}: rappresenta la coerenza dei dati ricevuti dal sensore IMU, utile a rilevare motor fault.
        \item \textit{critical\_mask \& degraded\_mask}: sono due mashere di errore a 8 bit, in cui ogni bit indica la presenza 
                    di un'anomalia \textit{critica} (da cui critical\_mask) o \textit{degradata} (da cui degraded\_mask) specifica.
    \end{itemize}
    \item \textbf{Board\_Health}: rappresenta lo stato della Board1. La struttura dati è la seguente:
        \begin{figure}[H]
            \centering
            \includegraphics[width=0.7\textwidth]{images/SupervisoreB1/BoardHealthSnapshot}
            \caption{Struttura dati Board\_Health.}
            \label{fig:board_health_struct}
        \end{figure}
    \item \textbf{Encoder}: rappresenta i dati provenienti dagli encoder delle ruote del rover. La struttura dati è la seguente:
        \begin{figure}[H]
            \centering
            \includegraphics[width=0.7\textwidth]{images/SupervisoreB1/Encoder\_snapshot}
            \caption{Struttura dati Encoder.}
            \label{fig:encoder_struct}
        \end{figure}
    \item \textbf{Now}: Rappresenta il tempo corrente in millisecondi.
    \item \textbf{Last\_valid\_b2\_ms}: Rappresenta il tempo in millisecondi dell'ultimo dato valido ricevuto dalla Board2.
\end{itemize}


\subsubsection{Output}
I segnali in output che fornisce sono:
\begin{itemize}
    \item \textbf{v\_ref}: rappresenta il riferimento di velocità lineare del rover, in m/s.
    \item \textbf{omega\_ref}: rappresenta il riferimento di velocità angolare del rover, in rad/s.
    
    \item \textbf{critical\_mask \& degraded\_mask}: sono due mashere di errore a 8 bit, in cui ogni bit indica la presenza 
    di un'anomalia \textit{critica} (da cui critical\_mask) o \textit{degradata} (da cui degraded\_mask) specifica, come descritto 
    nella Tabella~\ref{tab:fault_mapping}.
        \begin{table}[H]
            \centering
            \begin{tabular}{lll}
            \hline
            \textbf{Bit} & \textbf{ID Segnale} & \textbf{Descrizione dell'Anomalia} \\ \hline
            0 & TEMP\_CRI/DEG & Errore termico (Logica predittiva) \\
            1 & BATT\_CRI/DEG & Tensione batteria sotto soglia minima \\
            2 & COMM\_CRI/DEG & Errore ricezione Board-to-Board \\
            3-6 & WHEEL\_CRI/DEG & Guasti attuatori (FL, FR, RL, RR) \\
            7 & SUP\_CRI/DEG  & Timeout comunicazione Supervisore B2 \\ \hline
            \end{tabular}
            \caption{Mappatura della maschera di errore a 8 bit}
            \label{tab:fault_mapping}
        \end{table}
\end{itemize}

\subsection{Nuova subsection}



\end{document}